@page "/ai/agents/{AgentId}"
@using Ai4c.Agents
@using Variant = MudBlazor.Variant
@inherits StudioComponentBase
@inject ILocalizer Localizer

<PageTitle>@Localizer["Agent"]</PageTitle>

<MudContainer MaxWidth="MaxWidth.False">
    <PageHeading Text="@($"Agent: {_agent.Name}")" />

    <MudCard>
        <MudForm Model="@_agent"
                 @ref="@_form"
                 Validation="@((Func<AgentModel, bool>)(x => _validator.Validate(x).IsValid))"
                 ValidationDelay="0">

            <MudTabs Border="false" PanelClass="pa-6">
                <MudTabPanel Text="@Localizer["General"]">
                    <MudStack Spacing="8">
                        <MudTextField @bind-Value="_agent.Name"
                                      For="@(() => _agent.Name)"
                                      Immediate="true"
                                      Label="@Localizer["Name"]"
                                      Variant="Variant.Outlined"
                                      HelperText="@Localizer["The name of the agent."]" />

                        <MudTextField @bind-Value="_agent.Description"
                                      For="@(() => _agent.Description)"
                                      Immediate="false"
                                      Label="@Localizer["Description"]"
                                      Variant="Variant.Outlined"
                                      HelperText="@Localizer["A description about the role and purpose of this agent."]" />

                        <MudTextField @bind-Value="_agent.PromptTemplate"
                                      For="@(() => _agent.PromptTemplate)"
                                      Immediate="false"
                                      Lines="10"
                                      Label="@Localizer["Prompt Template"]"
                                      Variant="Variant.Outlined"
                                      HelperText="@Localizer["Used to define the initial instructions"]" />

                        <MudSelect @bind-Value="_agent.AgentLlmConfig.Provider"
                                   For="@(() => _agent.AgentLlmConfig.Provider)"
                                   Immediate="true"
                                   Label="@Localizer["Provider"]"
                                   Variant="Variant.Outlined"
                                   TextChanged="@OnProviderChanged"
                                   HelperText="@Localizer["The name of the llm Provider."]">
                            @foreach (var provider in Providers)
                            {
                                <MudSelectItem T="string" Value="@provider">@provider</MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect @bind-Value="_agent.AgentLlmConfig.Model"
                                   For="@(() => _agent.AgentLlmConfig.Model)"
                                   Immediate="true"
                                   Label="@Localizer["Model"]"
                                   Variant="Variant.Outlined"
                                   HelperText="@Localizer["The name of the llm Model."]">
                            @foreach (var model in LlmProviderModels)
                            {
                                <MudSelectItem T="string" Value="@model.Name">@model.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudStack>
                </MudTabPanel>
                <MudTabPanel Text="@Localizer["Input"]">
                    <MudTable T="AgentInputVariableConfig"
                              @ref="@_inputVariableTable"
                              Items="_agent.InputVariables"
                              Dense="true"
                              Hover="true"
                              CanCancelEdit="true"
                              EditTrigger="TableEditTrigger.EditButton"
                              SelectOnRowClick="true"
                              IsEditRowSwitchingBlocked="false"
                              RowEditPreview="BackupInputVariable"
                              RowEditCancel="RestoreInputVariable"
                              RowEditCommit="CommitInputVariable">
                        <ColGroup>
                            <col />
                            <col />
                            <col />
                            <col style="width:50px;" />
                            <col style="width:50px;" />
                        </ColGroup>
                        <HeaderContent>
                            <MudTh>@Localizer["Name"]</MudTh>
                            <MudTh>@Localizer["Type"]</MudTh>
                            <MudTh>@Localizer["Description"]</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Name">@context.Name</MudTd>
                            <MudTd DataLabel="Type">@context.Type</MudTd>
                            <MudTd DataLabel="Description">@context.Description</MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Outlined.Delete" OnClick="() => DeleteInputVariable(context)" />
                            </MudTd>
                        </RowTemplate>
                        <RowEditingTemplate>
                            <MudTd DataLabel="Name">
                                <MudTextField @bind-Value="@context.Name"
                                              For="@(() => context.Name)"
                                              Immediate="false"
                                              Label="@Localizer["Name"]"
                                              Variant="Variant.Outlined"
                                              HelperText="@Localizer["The technical name of the input variable"]" />
                            </MudTd>
                            <MudTd DataLabel="Type">
                                <MudSelect @bind-Value="@context.Type"
                                           T="string"
                                           For="@(() => context.Type)"
                                           Immediate="false"
                                           Label="@Localizer["Type"]"
                                           Variant="Variant.Outlined"
                                           HelperText="@Localizer["The .NET type of the input variable."]">
                                    <MudSelectItem T="string" Value="@("string")">@Localizer["string"]</MudSelectItem>
                                    <MudSelectItem T="string" Value="@("int")">@Localizer["int"]</MudSelectItem>
                                    <MudSelectItem T="string" Value="@("object")">@Localizer["object"]</MudSelectItem>
                                </MudSelect>
                            </MudTd>
                            <MudTd DataLabel="@Localizer["Description"]">
                                <MudTextField @bind-Value="@context.Description"
                                              For="@(() => context.Description)"
                                              Immediate="false"
                                              Label="@Localizer["Description"]"
                                              Variant="Variant.Outlined"
                                              HelperText="@Localizer["A description about the role and purpose of this input variable."]" />
                            </MudTd>
                            <MudTd></MudTd>
                        </RowEditingTemplate>
                    </MudTable>
                    <MudButton Class="mt-2" Color="Color.Secondary" Variant="Variant.Filled" OnClick="@OnAddInputVariableClicked">@Localizer["Add"]</MudButton>
                </MudTabPanel>

                <MudTabPanel Text="@Localizer["Output"]">
                    <MudTable T="AgentOutputVariableConfig"
                              @ref="@_outputVariableTable"
                              Items="_agent.OutputVariables"
                              Dense="true"
                              Hover="true"
                              CanCancelEdit="true"
                              EditTrigger="TableEditTrigger.EditButton"
                              SelectOnRowClick="true"
                              IsEditRowSwitchingBlocked="false"
                              RowEditPreview="BackupOutputVariable"
                              RowEditCancel="RestoreOutputVariable"
                              RowEditCommit="CommitOutputVariable">
                        <ColGroup>
                            <col />
                            <col />
                            <col />
                            <col style="width:50px;" />
                            <col style="width:50px;" />
                        </ColGroup>
                        <HeaderContent>
                            <MudTh>@Localizer["Name"]</MudTh>
                            <MudTh>@Localizer["Type"]</MudTh>
                            <MudTh>@Localizer["Description"]</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Name">@context.Name</MudTd>
                            <MudTd DataLabel="Type">@context.Type</MudTd>
                            <MudTd DataLabel="Description">@context.Description</MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Outlined.Delete" OnClick="() => DeleteOutputVariable(context)" />
                            </MudTd>
                        </RowTemplate>
                        <RowEditingTemplate>
                            <MudTd DataLabel="Name">
                                <MudTextField @bind-Value="@context.Name"
                                              For="@(() => context.Name)"
                                              Immediate="false"
                                              Label="@Localizer["Name"]"
                                              Variant="Variant.Outlined"
                                              HelperText="@Localizer["The technical name of the input variable"]" />
                            </MudTd>
                            <MudTd DataLabel="Type">
                                <MudSelect @bind-Value="@context.Type"
                                           T="string"
                                           For="@(() => context.Type)"
                                           Immediate="false"
                                           Label="@Localizer["Type"]"
                                           Variant="Variant.Outlined"
                                           HelperText="@Localizer["The .NET type of the input variable."]">
                                    <MudSelectItem T="string" Value="@("string")">@Localizer["string"]</MudSelectItem>
                                    <MudSelectItem T="string" Value="@("int")">@Localizer["int"]</MudSelectItem>
                                    <MudSelectItem T="string" Value="@("object")">@Localizer["object"]</MudSelectItem>
                                </MudSelect>
                            </MudTd>
                            <MudTd DataLabel="@Localizer["Description"]">
                                <MudTextField @bind-Value="@context.Description"
                                              For="@(() => context.Description)"
                                              Immediate="false"
                                              Label="@Localizer["Description"]"
                                              Variant="Variant.Outlined"
                                              HelperText="@Localizer["A description about the role and purpose of this input variable."]" />
                            </MudTd>
                            <MudTd></MudTd>
                        </RowEditingTemplate>
                    </MudTable>
                    <MudButton Class="mt-2" Color="Color.Secondary" Variant="Variant.Filled" OnClick="@OnAddOutputVariableClicked">@Localizer["Add"]</MudButton>
                </MudTabPanel>
            </MudTabs>
        </MudForm>
        <MudCardActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="@(async () => await OnSaveClicked())">@Localizer["Save"]</MudButton>
        </MudCardActions>
    </MudCard>
</MudContainer>